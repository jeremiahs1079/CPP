var evalkit_stoploop = 0, EvaluationKIT = { onLoad: function () { if (this.endsWith(window.location.toString(), "login")) return void this.logout(); if (!ENV || void 0 == ENV) return void console.log("EvaluationKIT : ENV is undefined"); if (!(0 === evalkit_setup.auth_external_tool_id || null === ENV.current_user_id || "evalkitiframe" === window.name || 0 === $("#section-tabs").length && -1 === window.location.toString().indexOf("/courses/") || window.location.toString().indexOf("/quizzes") > -1 || -1 != navigator.userAgent.indexOf("Safari") && -1 === navigator.userAgent.indexOf("Chrome") && -1 != navigator.userAgent.indexOf("Windows") || (evalkit_stoploop += 1, evalkit_stoploop > 3))) { var t = this.getWSUrlCookie(), e = this.getTokenCookie(), o = this.getVerifyCookie(); 0 === t.length || 0 === e.length || o !== ENV.current_user_id ? this.onLti() : this.onUser(e) } }, onLti: function () { try { var t = "/users/" + ENV.current_user_id + "/external_tools/" + evalkit_setup.auth_external_tool_id; window.addEventListener ? window.addEventListener("message", this.onLtiResponse, !1) : window.attachEvent("onmessage", this.onLtiResponse), $('<iframe src="' + t + '" id="evalkit-lti" name="evalkitiframe" style="display:none;"></iframe>').appendTo($("body")) } catch (e) { this.onError(e) } }, onLtiResponse: function (t) { var e = EvaluationKIT || {}; try { var o = JSON.parse(t.data); if (void 0 === o) return; var n = o.token; 0 === n.length && (n = "-1"), e.setWSUrlCookie(o.wsurl), e.setTokenCookie(n), e.setVerifyCookie(ENV.current_user_id) } catch (t) { var i = EvaluationKIT || {}; i.onError(t) } e.onLoad() }, onUser: function (t) { if ("-1" !== t) { var e = this.getPageCourseId(), o = this.getWSUrlCookie(), n = this.getPageCourseCode(e), i = o + "/canvas/usersettings?token=" + encodeURIComponent(t) + (e.length > 0 ? "&courseid=" + e + "&coursecode=" + encodeURIComponent(n) : ""), r = this.createCORSRequest("GET", i); r && (r.onload = function () { if (401 === r.status) { var t = EvaluationKIT || {}; t.onLti() } else try { var e = $.parseJSON(r.responseText), t = EvaluationKIT || {}; t.onPopup(e), t.onLinks(e) } catch (o) { var n = EvaluationKIT || {}; n.onError(o) } }, r.onerror = function (t) { var e = EvaluationKIT || {}; navigator.appVersion.indexOf("MSIE 10") > -1 || navigator.appVersion.indexOf("MSIE 9") > -1 ? e.onLti() : e.onError(t) }, r.send()) } }, createCORSRequest: function (t, e) { try { var o = new XMLHttpRequest; return "withCredentials" in o ? o.open(t, e, !0) : "undefined" != typeof XDomainRequest ? (o = new XDomainRequest, o.open(t, e)) : o = null, o } catch (n) { this.onError(n) } }, onPopup: function (t) { var e = this.getPageCourseId(); if (-1 !== window.location.toString().indexOf("/courses/") && (this.endsWith(window.location.toString(), "/courses/" + e) || this.endsWith(window.location.toString(), "/courses/" + e + "/") || !t.popup.remindlater) && !(this.endsWith(window.location.toString(), "/external_tools/" + t.studentlink.exttoolid) || this.endsWith(window.location.toString(), "/external_tools/" + t.studentlink.exttoolid + "/") || this.endsWith(window.location.toString(), "/external_tools/" + t.instructorlink.exttoolid) || this.endsWith(window.location.toString(), "/external_tools/" + t.instructorlink.exttoolid + "/") || this.endsWith(window.location.toString(), "/external_tools/" + t.adminlink.exttoolid) || this.endsWith(window.location.toString(), "/external_tools/" + t.adminlink.exttoolid + "/")) && t.popup.visible) { var o = $('<div id="evalkit-popup" />'); o.appendTo($("body")), o.html(t.popup.body); var n = {}, i = t.popup.gotosurveytext, r = t.popup.remindlatertext; i == r && (r += " "), n[i] = function () { var o = ""; -1 != navigator.userAgent.indexOf("Safari") && -1 === navigator.userAgent.indexOf("Chrome") && (o = evalkit_setup.account_url + "/MyEval/SafariRedirect.aspx?ret=" + document.location.origin), o += t.popup.gotosurvey ? "/courses/" + e + "/external_tools/" + t.studentlink.exttoolid : "/users/" + ENV.current_user_id + "/external_tools/" + t.userlink.exttoolid, document.location.href = o }, t.popup.remindlater && (n[r] = function () { o.dialog("close") }), o.dialog({ width: t.popup.width, height: t.popup.height, modal: !0, resizable: !1, draggable: !1, title: t.popup.header, show: "clip", hide: "explode", closeOnEscape: !1, open: function () { $(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").hide() }, buttons: n }), this.fixScroll() } }, onLinks: function (t) { var e = -1 != navigator.userAgent.indexOf("Safari") && -1 === navigator.userAgent.indexOf("Chrome"); this.setLink(t.userlink, e), this.setLink(t.studentlink, e), this.setLink(t.instructorlink, e), this.setLink(t.adminlink, e) }, getPageCourseId: function () { return $("body").attr("class").match(/\bcontext-course_(.[0-9]*)/) ? $("body").attr("class").match(/\bcontext-course_(.[0-9]*)/)[1] : "" }, getPageCourseCode: function () { return $("#breadcrumbs ul li:nth-child(2) span").text() }, getPageUserId: function () { return $("body").attr("class").match(/\bcontext-user_(.[0-9]*)/) ? $("body").attr("class").match(/\bcontext-user_(.[0-9]*)/)[1] : "" }, getRootAccount: function () { return $("#domain_root_account_id").html() }, endsWith: function (t, e) { return -1 !== t.indexOf(e, t.length - e.length) }, getWSUrlCookie: function () { return sessionStorage.getItem("evalkit_wsurl") || "" }, setWSUrlCookie: function (t) { sessionStorage.setItem("evalkit_wsurl", t) }, getTokenCookie: function () { return sessionStorage.getItem("evalkit_token") || "" }, setTokenCookie: function (t) { sessionStorage.setItem("evalkit_token", t) }, getVerifyCookie: function () { return sessionStorage.getItem("evalkit_verify") || "" }, setVerifyCookie: function (t) { sessionStorage.setItem("evalkit_verify", t) }, setLink: function (t, e) { if (0 != t.exttoolid) { var o = $("a.context_external_tool_" + t.exttoolid); e && o.click(function (t) { t.preventDefault(), document.location.href = evalkit_setup.account_url + "/MyEval/SafariRedirect.aspx?ret=" + document.location.origin + $(this).attr("href") }), (2 != t.linktype || 0 != this.getPageUserId().length) && (2 == t.linktype && this.getPageUserId().length > 0 ? t.visible ? 0 == o.length ? $("<li class='section evalkitlink'><a class='evalkituser' href='/users/" + ENV.current_user_id + "/external_tools/" + t.exttoolid + "'>" + t.title + "</a></li>").appendTo("#section-tabs") : o.attr("style", "display:block !important;") : o.parent().remove() : this.getPageCourseId().length > 0 && (t.visible ? 0 == o.length ? $("<li class='section evalkitlink'><a class='evalkitcourse' href='/courses/" + this.getPageCourseId() + "/external_tools/" + t.exttoolid + "'>" + t.title + "</a></li>").appendTo("#section-tabs") : o.attr("style", "display:block !important;") : o.parent().remove())) } }, fixScroll: function () { var t = function () { $("#evalkit-popup").dialog("option", "position", ["center", "center"]) }; $(window).scroll(function () { t() }), $(window).resize(function () { t() }) }, logout: function () { this.setTokenCookie(""), this.setWSUrlCookie(""), this.setVerifyCookie("") }, onError: function (t) { console.log("EvaluationKIT Canvas User Integration Error: " + t), console.log("EvaluationKIT Canvas User Integration Error Stack: " + t.stack) } }; $(document).ready(function () { -1 != navigator.userAgent.indexOf("Safari") && -1 === navigator.userAgent.indexOf("Chrome") && $(".tool_content_wrapper").css("-webkit-overflow-scrolling", "touch").css("overflow-y", "scroll"), EvaluationKIT.onLoad() });